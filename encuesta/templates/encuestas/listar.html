{% extends "base.html" %}
{% block pagetitle %}<h1>Encuestas Internas</h1>{% endblock %}
{% block contenido %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/dataTables.min.css' %}">
<link rel="stylesheet" href="{% static 'css/responsive.dataTables.min.css' %}">
<div class="container mt-3">
  
  <!-- TOAST de mensajes Django -->
  {% if messages %}
  <div aria-live="polite" aria-atomic="true" class="position-absolute top-0 end-0 p-3" style="z-index: 1080; right: 0; top: 0;">
    {% for message in messages %}
    <div class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3500">
      <div class="d-flex">
        <div class="toast-body">
          {{ message }}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  <!-- TOAST para AJAX -->
  <div aria-live="polite" aria-atomic="true" class="position-absolute top-0 end-0 p-3" style="z-index: 1080; right: 0; top: 0;">
    <div id="toast-container"></div>
  </div>

<div class="d-flex justify-content-between mb-3">
    <h2>Lista de Encuestas Internas</h2>
    <button type="button" class="btn btn-outline-primary btn-sm d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#modalCrearEncuesta">
        <i class="fa fa-plus me-1"></i> Añadir Nueva Encuesta
    </button>
</div>
<div style="overflow-x:auto;">
{% if encuestas %}
<table id="tabla-encuestas" class="table table-striped text-center align-middle">
    <thead>
        <tr>
            <th style="width: 40px;">#</th>
            <th style="max-width: 220px;">Título</th>
            <th style="max-width: 220px;">Descripción</th>
            <th>Finalizar</th>
            <th>Estado</th>
            <th style="width: 120px;">Acción</th>
        </tr>
    </thead>
    <tbody id="tbody-encuestas">
        {% for encuesta in encuestas %}
        <tr>
            <td>{{ forloop.counter }}</td>
            <td style="max-width:180px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
                <strong>{{ encuesta.titulo|truncatechars:30 }}</strong>
            </td>
            <td style="max-width:180px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
                {% if encuesta.descripcion %}
                    {{ encuesta.descripcion|truncatechars:30 }}
                {% else %}
                    <span class="text-muted">Sin descripción</span>
                {% endif %}
            </td>
            <td>
                {% if encuesta.fecha_finalizacion %}
                    {{ encuesta.fecha_finalizacion|date:"M d, Y" }}
                {% else %}
                    <span class="text-muted">Sin fecha</span>
                {% endif %}
            </td>
            <td>
                {% if not encuesta.fecha_finalizacion_date or encuesta.fecha_finalizacion_date > today %}
                    <button type="button"
                            class="badge bg-success border-0"
                            style="cursor:pointer;"
                            data-bs-toggle="modal"
                            data-bs-target="#modalEstadoEncuesta"
                            data-id="{{ encuesta.id }}"
                            data-action="desactivar"
                            data-titulo="{{ encuesta.titulo }}">
                        En Curso
                    </button>
                {% else %}
                    <button type="button"
                            class="badge bg-secondary border-0"
                            style="cursor:pointer;"
                            data-bs-toggle="modal"
                            data-bs-target="#modalReabrirEncuesta"
                            data-id="{{ encuesta.id }}">
                        Finalizada
                    </button>
                {% endif %}
            </td>
            <td style="width: 120px;">
                <div class="d-flex justify-content-center flex-wrap gap-1">
                    {% if not encuesta.fecha_finalizacion_date or encuesta.fecha_finalizacion_date > today %}
                        <button type="button" class="btn btn-primary btn-sm btn-editar-encuesta"
                            data-bs-toggle="modal"
                            data-bs-target="#modalEditarEncuesta"
                            data-id="{{ encuesta.id }}"
                            data-titulo="{{ encuesta.titulo|escapejs }}"
                            data-descripcion="{{ encuesta.descripcion|default:''|escapejs }}"
                            data-fecha_finalizacion="{{ encuesta.fecha_finalizacion|date:'Y-m-d' }}"
                            title="Editar">
                            <i class="fa fa-edit"></i>
                        </button>
                        {% if request.user.is_superuser %}
                            <a href="#" class="btn btn-danger btn-sm" title="Borrar"
                              data-bs-toggle="modal"
                              data-bs-target="#borrarEncuestaModal"
                              data-id="{{ encuesta.id }}"
                              data-titulo="{{ encuesta.titulo }}">
                              <i class="fa fa-trash"></i>
                            </a>
                        {% endif %}
                    {% endif %}
                    <a href="{% url 'detalle_encuesta' encuesta.id %}" class="btn btn-info btn-sm" title="Ver detalles">
                      <i class="fas fa-eye"></i>
                  </a>
                </div>
            </td>
         </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="alert alert-info text-center mt-3" style="background-color: #c7f4fa; color: #21829c;">
    No hay encuestas registradas.
</div>
{% endif %}
</div>

<!-- Incluir los modales -->
{% include 'encuestas/modales_encuesta/modales.html' %}

{% endblock %}

{% block scripts %}
<script src="{% static 'js/jquery-3.7.0.min.js' %}"></script>
<script src="{% static 'js/dataTables.min.js' %}"></script>
<script src="{% static 'js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'js/encuesta/encuesta.js' %}"></script>

<!-- Variables globales para las URLs -->
<script>
  window.urlEnviarPapelera = "{% url 'enviar_a_papelera_encuesta' 0 %}";
  window.urlDesactivarEncuesta = "{% url 'desactivar_encuesta' 0 %}";
  window.urlReabrirEncuesta = "{% url 'reabrir_encuesta' 0 %}";
  window.urlCrearEncuesta = "{% url 'crear_encuesta' %}";
  window.urlEditarEncuesta = "{% url 'editar_encuesta' 0 %}";
  window.urlDetalleEncuesta = "{% url 'detalle_encuesta' 0 %}";
  window.isSuperuser = {% if request.user.is_superuser %}true{% else %}false{% endif %};
</script>

<script src="{% static 'js/encuesta/listar.js' %}"></script>

{% if request.GET.abrir_modal_reabrir %}
<script>
$(document).ready(function() {
    $('#modalReabrirEncuesta').modal('show');
    var encuestaId = "{{ request.GET.abrir_modal_reabrir }}";
    var form = $('#formReabrirEncuesta');
    var actionUrl = "{% url 'reabrir_encuesta' 0 %}".replace('0', encuestaId);
    form.attr('action', actionUrl);
});
</script>
{% endif %}
{% endblock %}